stages:
  - build
  - deploy

build_image:
  stage: build
  image: docker:20.10.16
  script:
    - docker build -t 10.3.1.10:5000/microblog:latest .
    - docker push 10.3.1.10:5000/microblog:latest
  tags:
    - docker

deploy_to_swarm:
  stage: deploy
  image: docker:20.10.16
  script:
    - docker service ls | grep microblog || docker service create --name microblog --replicas 3 -p 8080:80 10.3.1.10:5000/microblog:latest
    - docker service update --image 10.3.1.10:5000/microblog:latest microblog
  tags:
    - docker
